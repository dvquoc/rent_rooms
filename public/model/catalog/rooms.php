<?php
class ModelCatalogRooms extends Model {
    protected $_table = null;
    protected $_name_col;

    public function __construct($registry)
    {
        parent::__construct($registry);
        $this->_table = $this->prefix_rooms.'rooms';
    }

    public function find($data){
        $sql= 'SELECT * FROM `'. $this->_table .'` WHERE (1=1) AND ';

        if (isset($data['ads']) && $data['ads'] >=0) {
                $sql .= "ads = ".$data['ads'].' AND ';
        }
        if (!empty($data['ads_position']) && $data['ads_position'] != -1) {
            $sql .= 'ads_position = "'.$data['ads_position'].'" AND ';
        }
        if (isset($data['close_door']) && $data['close_door'] >=0) {
            $sql .= 'close_door = '.$data['close_door'].' AND ';
        }
        if (isset($data['price']) && $data['price']>0) {
            $sql .= 'price = '.$data['price'].' AND ';
        }
        if (isset($data['acreage']) && $data['acreage']>0) {
            $sql .= 'acreage = '.$data['acreage'].' AND ';
        }
        if (!empty($data['name']) && $data['name'] != -1) {
            $sql .= 'name LIKE "% '.$data['name'].' %" AND ';
        }

        //$data['special'] ='10.7522818 106.4810371, 10.721729797019426 106.534837857345167, 10.7029483 106.5678978, 10.7005869 106.570816, 10.6842248 106.567211200000017, 10.6641506 106.56944270000001, 10.658921 106.5793991, 10.6695488 106.58729550000001, 10.6629697 106.5975952, 10.6671871 106.6008568, 10.6565592 106.6453171, 10.6513294 106.6451454, 10.6496424 106.6588783, 10.6390138 106.6690063, 10.6422193 106.6732979, 10.6320966 106.6757011, 10.6314217 106.6851425, 10.6282161 106.6835976, 10.6270351 106.6863441, 10.6233233 106.691494, 10.6199489 106.6988754, 10.6138749 106.707630200000011, 10.6088131 106.707630200000011, 10.6071258 106.7179298, 10.5998704 106.7222214, 10.5964958 106.7198181, 10.5916024 106.7241096, 10.5865403 106.714325, 10.5740533 106.7129517, 10.5727034 106.7193031, 10.5681472 106.7215347, 10.5635909 106.7344093, 10.5646034 106.7459106, 10.5485716 106.751747100000017, 10.4783593 106.7575836, 10.4567523 106.7714882, 10.4055985 106.8169785, 10.3762193 106.8799782, 10.3755439 106.8976593, 10.4055985 106.9706154, 10.4137027 106.9759369, 10.4550642 106.9756794, 10.4891622 106.990099, 10.5254506 107.0147324, 10.5366737 107.0275211, 10.5437619 107.026577, 10.5506811 107.0115566, 10.5636753 107.0133591, 10.5840092 107.0276928, 10.6060291 107.0175648, 10.6240825 106.9959354, 10.6110065 106.981945, 10.5795375 106.9822884, 10.5929523 106.961689, 10.5997861 106.9359398, 10.6091506 106.9204044, 10.6075476 106.912937200000016, 10.6158152 106.908474, 10.6479553 106.8824673, 10.6417131 106.8651295, 10.6369892 106.8586922, 10.6393512 106.8523407, 10.6386764 106.8450451, 10.6358926 106.8411827, 10.6273725 106.837492, 10.6266977 106.8289948, 10.6315061 106.8216133, 10.6419662 106.8134594, 10.6552939 106.8092537, 10.6622106 106.797924, 10.6718262 106.7817879, 10.6819476 106.7684841, 10.6948518 106.7570686, 10.7075025 106.7502022, 10.7263089 106.7538929, 10.7404762 106.768055, 10.7521974 106.785392800000011, 10.7601238 106.8008423, 10.7673753 106.805563, 10.7760601 106.8113995, 10.7806975 106.8175793, 10.7806975 106.8235874, 10.7763974 106.8256474, 10.7704108 106.824789, 10.7610513 106.8229866, 10.7591962 106.8271065, 10.7650144 106.8319988, 10.7710011 106.8381786, 10.7753013 106.8432426, 10.7744581 106.8501091, 10.773109 106.8563747, 10.7677126 106.8611813, 10.7645928 106.8676186, 10.7667851 106.8727684, 10.773362 106.8740559, 10.7821309 106.864786100000018, 10.790478 106.8666744, 10.7985719 106.8764591, 10.8064971 106.8822956, 10.816361 106.8798065, 10.8276578 106.8705368, 10.8410616 106.8565464, 10.8484798 106.852684, 10.8571622 106.8490791, 10.868255859962892 106.844694479808581, 10.8699747 106.8440151, 10.8857366 106.8428993, 10.901582 106.8396378, 10.8978736 106.8283939, 10.8959351 106.825819, 10.879668 106.8132877, 10.8861581 106.8033314, 10.8858209 106.8006706, 10.8869166 106.7993832, 10.892648 106.7899418, 10.8907938 106.7857361, 10.890288 106.7817879, 10.8891081 106.7782688, 10.8871695 106.7748356, 10.884388 106.7714024, 10.8806794 106.7684841, 10.882028 106.7639351, 10.8741892 106.7613602, 10.872951733379557 106.760730148395822, 10.8721662 106.7603302, 10.8696375 106.7633343, 10.8672774 106.7623901, 10.867446 106.7595577, 10.8659287 106.7537212, 10.8673617 106.7535496, 10.8672774 106.751747100000017, 10.8664345 106.7504597, 10.8655915 106.7483139, 10.8652544 106.7465973, 10.8666873 106.7449665, 10.8689632 106.744194, 10.8720819 106.7419624, 10.873818974060896 106.745178475361257, 10.8739363 106.7453957, 10.8790779 106.7421341, 10.881438 106.7399025, 10.8798365 106.7381859, 10.8816066 106.735096, 10.8843038 106.728744500000019, 10.8824494 106.7255688, 10.8805108 106.7226505, 10.8789936 106.7213631, 10.875012470058481 106.723753157959678, 10.8676988 106.7281437, 10.865423 106.723938, 10.8612926 106.7163849, 10.8643272 106.7154408, 10.8660973 106.7099476, 10.8670245 106.7022228, 10.8716605 106.696386300000015, 10.876765893989296 106.692227400705619, 10.8788251 106.6905499, 10.8823652 106.6889191, 10.8864109 106.689777400000011, 10.8948394 106.6947556, 10.9047004 106.6926098, 10.914814 106.6885757, 10.9218932 106.6841984, 10.9233259 106.6796494, 10.9207134 106.669693, 10.9215561 106.6655731, 10.926107 106.6563892, 10.9311634 106.6514969, 10.9361355 106.6496086, 10.941866 106.651411100000018, 10.9530737 106.6522694, 10.9641125 106.6486645, 10.9697581 106.6491795, 10.9758249 106.6500378, 10.9813018 106.6480637, 10.980712 106.6434288, 10.9770889 106.6353607, 10.9797852 106.6269493, 10.9850935 106.6217995, 10.9886323 106.616478, 10.9925081 106.6163063, 10.9978162 106.6188812, 11.0046407 106.621713600000021, 11.0108753 106.6185379, 11.0113808 106.6106415, 11.0145823 106.5989685, 11.01989 106.5960503, 11.0288201 106.5949345, 11.0393506 106.60326, 11.0427203 106.6019726, 11.0456687 106.599226, 11.0458372 106.5960503, 11.0439839 106.5934753, 11.0416252 106.592273700000021, 11.0369918 106.5913296, 11.0362336 106.5871239, 11.0379185 106.5829182, 11.0409512 106.5813732, 11.0463427 106.5808582, 11.0494595 106.5772533, 11.0536715 106.5745068, 11.0545139 106.571760200000014, 11.0511443 106.5692711, 11.0455003 106.5680695, 11.0450791 106.5630913, 11.0464269 106.55056, 11.0498807 106.5482426, 11.0535873 106.5441227, 11.0559459 106.5371704, 11.057639978163111 106.534837857345167, 11.0590627 106.5328789, 11.0657173 106.5297031, 11.0689182 106.5254974, 11.0731299 106.5239525, 11.0769204 106.5244675, 11.0825638 106.527986500000011, 11.0876176 106.533308, 11.0902287 106.533823, 11.0923343 106.5319347, 11.0898917 106.5251541, 11.0903971 106.5222359, 11.0973879 106.5172577, 11.1012623 106.5163136, 11.1037048 106.5239525, 11.1058946 106.5266132, 11.1153275 106.5279007, 11.1214755 106.5263557, 11.122065 106.5209484, 11.1267813 106.5145111, 11.1350344 106.5115929, 11.1422768 106.5073872, 11.1400031 106.501379, 11.1445506 106.489706, 11.142361 106.4823246, 11.14354 106.472196600000018, 11.1482559 106.4673901, 11.1544874 106.4712524, 11.1577716 106.4661026, 11.159961 106.4632702, 11.1586137 106.4614677, 11.158361 106.459322, 11.1602136 106.4568329, 11.1593715 106.4536572, 11.1565084 106.451683, 11.1524664 106.4514256, 11.1513717 106.4530563, 11.1532243 106.4559746, 11.152719 106.4581203, 11.1477506 106.4585495, 11.1410978 106.4558029, 11.1364661 106.4514256, 11.1355397 106.446619, 11.1080002 106.4389801, 11.0842484 106.4389801, 11.0815531 106.4295387, 11.0259558 106.4278221, 11.0156775 106.4353752, 11.0059045 106.4273071, 11.0039667 106.4239597, 10.9966366 106.4204407, 10.9909915 106.4100552, 10.9913285 106.392889, 10.9938562 106.372633, 10.9922553 106.3700581, 10.9818916 106.3637066, 10.9809648 106.3649082, 10.9695896 106.3734055, 10.9737184 106.4113426, 10.9416974 106.4536572, 10.9207976 106.4959717, 10.9033519 106.533823, 10.885800670774429 106.528854385194066, 10.7887074 106.501379, 10.7522818 106.4810371';
        if (!empty($data['type']) && $data['type'] != -1 && !empty($data['special']) && $data['special'] != -1) {
                $sql .= "ST_Contains(GeomFromText('POLYGON((" . $data['special'] . "))'), Point(lat,lng)) AND ";
        }

        $sql .= "status = " . $data['status'];

        $sort_data = array(
            'name',
            'create_date'
        );

        if (isset($data['sort']) && in_array($data['sort'], $sort_data)) {
            $sql .= " ORDER BY " . $data['sort'];
        } else {
            $sql .= " ORDER BY name";
        }

        if (isset($data['order']) && ($data['order'] == 'DESC')) {
            $sql .= " DESC";
        } else {
            $sql .= " ASC";
        }

        if (isset($data['start']) || isset($data['limit'])) {
            if ($data['start'] < 0) {
                $data['start'] = 0;
            }

            if ($data['limit'] < 1) {
                $data['limit'] = 20;
            }

            $sql .= " LIMIT " . (int)$data['start'] . "," . (int)$data['limit'];
        }
        //var_dump($sql); die();
        $query = $this->db->query($sql);
        return $query->rows;
    }

    public function addRooms($data){
        $set_tring = $this->__setStringUpdate($data);
        $sql="INSERT `" . $this->_table . "` SET " . $set_tring;
        $this->db->query($sql);
        $this->cache->delete('rooms');
        $this->cache->delete('alias-cache-'.$this->config->get('config_language_id'));
    }

    public function editRooms($rooms_id, $data = array()){
        $set_tring = $this->__setStringUpdate($data);
        $sql="UPDATE `" . $this->_table . "` SET " . trim($set_tring,",");
        $sql.=" WHERE room_id = " . (int)$rooms_id ;
        //var_dump($sql); die();
        $this->db->query($sql);
        $this->cache->delete('rooms');
        $this->cache->delete('alias-cache-'.$this->config->get('config_language_id'));
    }

    public function getRoom($rooms_id){
        $query = $this->db->query("SELECT DISTINCT * FROM "."1_1_rooms WHERE room_id = '" . (int)$rooms_id . "'");
        return $query->row;
    }
    public function getTotalRooms($data){

        $sql= 'SELECT COUNT(*) AS total FROM `'. $this->_table .'` WHERE (1=1) AND ';

        if (isset($data['ads']) && $data['ads'] >=0) {
            $sql .= "ads = ".$data['ads'].' AND ';
        }
        if (!empty($data['ads_position']) && $data['ads_position'] != -1) {
            $sql .= 'ads_position = "'.$data['ads_position'].'" AND ';
        }
        if (isset($data['close_door']) && $data['close_door'] >=0) {
            $sql .= 'close_door = '.$data['close_door'].' AND ';
        }
        if (isset($data['price']) && $data['price']>0) {
            $sql .= 'price = '.$data['price'].' AND ';
        }
        if (isset($data['acreage']) && $data['acreage']>0) {
            $sql .= 'acreage = '.$data['acreage'].' AND ';
        }
        if (!empty($data['name']) && $data['name'] != -1) {
            $sql .= 'name LIKE % '.$data['name'].' % ';
        }

        //$data['special'] ='10.7522818 106.4810371, 10.721729797019426 106.534837857345167, 10.7029483 106.5678978, 10.7005869 106.570816, 10.6842248 106.567211200000017, 10.6641506 106.56944270000001, 10.658921 106.5793991, 10.6695488 106.58729550000001, 10.6629697 106.5975952, 10.6671871 106.6008568, 10.6565592 106.6453171, 10.6513294 106.6451454, 10.6496424 106.6588783, 10.6390138 106.6690063, 10.6422193 106.6732979, 10.6320966 106.6757011, 10.6314217 106.6851425, 10.6282161 106.6835976, 10.6270351 106.6863441, 10.6233233 106.691494, 10.6199489 106.6988754, 10.6138749 106.707630200000011, 10.6088131 106.707630200000011, 10.6071258 106.7179298, 10.5998704 106.7222214, 10.5964958 106.7198181, 10.5916024 106.7241096, 10.5865403 106.714325, 10.5740533 106.7129517, 10.5727034 106.7193031, 10.5681472 106.7215347, 10.5635909 106.7344093, 10.5646034 106.7459106, 10.5485716 106.751747100000017, 10.4783593 106.7575836, 10.4567523 106.7714882, 10.4055985 106.8169785, 10.3762193 106.8799782, 10.3755439 106.8976593, 10.4055985 106.9706154, 10.4137027 106.9759369, 10.4550642 106.9756794, 10.4891622 106.990099, 10.5254506 107.0147324, 10.5366737 107.0275211, 10.5437619 107.026577, 10.5506811 107.0115566, 10.5636753 107.0133591, 10.5840092 107.0276928, 10.6060291 107.0175648, 10.6240825 106.9959354, 10.6110065 106.981945, 10.5795375 106.9822884, 10.5929523 106.961689, 10.5997861 106.9359398, 10.6091506 106.9204044, 10.6075476 106.912937200000016, 10.6158152 106.908474, 10.6479553 106.8824673, 10.6417131 106.8651295, 10.6369892 106.8586922, 10.6393512 106.8523407, 10.6386764 106.8450451, 10.6358926 106.8411827, 10.6273725 106.837492, 10.6266977 106.8289948, 10.6315061 106.8216133, 10.6419662 106.8134594, 10.6552939 106.8092537, 10.6622106 106.797924, 10.6718262 106.7817879, 10.6819476 106.7684841, 10.6948518 106.7570686, 10.7075025 106.7502022, 10.7263089 106.7538929, 10.7404762 106.768055, 10.7521974 106.785392800000011, 10.7601238 106.8008423, 10.7673753 106.805563, 10.7760601 106.8113995, 10.7806975 106.8175793, 10.7806975 106.8235874, 10.7763974 106.8256474, 10.7704108 106.824789, 10.7610513 106.8229866, 10.7591962 106.8271065, 10.7650144 106.8319988, 10.7710011 106.8381786, 10.7753013 106.8432426, 10.7744581 106.8501091, 10.773109 106.8563747, 10.7677126 106.8611813, 10.7645928 106.8676186, 10.7667851 106.8727684, 10.773362 106.8740559, 10.7821309 106.864786100000018, 10.790478 106.8666744, 10.7985719 106.8764591, 10.8064971 106.8822956, 10.816361 106.8798065, 10.8276578 106.8705368, 10.8410616 106.8565464, 10.8484798 106.852684, 10.8571622 106.8490791, 10.868255859962892 106.844694479808581, 10.8699747 106.8440151, 10.8857366 106.8428993, 10.901582 106.8396378, 10.8978736 106.8283939, 10.8959351 106.825819, 10.879668 106.8132877, 10.8861581 106.8033314, 10.8858209 106.8006706, 10.8869166 106.7993832, 10.892648 106.7899418, 10.8907938 106.7857361, 10.890288 106.7817879, 10.8891081 106.7782688, 10.8871695 106.7748356, 10.884388 106.7714024, 10.8806794 106.7684841, 10.882028 106.7639351, 10.8741892 106.7613602, 10.872951733379557 106.760730148395822, 10.8721662 106.7603302, 10.8696375 106.7633343, 10.8672774 106.7623901, 10.867446 106.7595577, 10.8659287 106.7537212, 10.8673617 106.7535496, 10.8672774 106.751747100000017, 10.8664345 106.7504597, 10.8655915 106.7483139, 10.8652544 106.7465973, 10.8666873 106.7449665, 10.8689632 106.744194, 10.8720819 106.7419624, 10.873818974060896 106.745178475361257, 10.8739363 106.7453957, 10.8790779 106.7421341, 10.881438 106.7399025, 10.8798365 106.7381859, 10.8816066 106.735096, 10.8843038 106.728744500000019, 10.8824494 106.7255688, 10.8805108 106.7226505, 10.8789936 106.7213631, 10.875012470058481 106.723753157959678, 10.8676988 106.7281437, 10.865423 106.723938, 10.8612926 106.7163849, 10.8643272 106.7154408, 10.8660973 106.7099476, 10.8670245 106.7022228, 10.8716605 106.696386300000015, 10.876765893989296 106.692227400705619, 10.8788251 106.6905499, 10.8823652 106.6889191, 10.8864109 106.689777400000011, 10.8948394 106.6947556, 10.9047004 106.6926098, 10.914814 106.6885757, 10.9218932 106.6841984, 10.9233259 106.6796494, 10.9207134 106.669693, 10.9215561 106.6655731, 10.926107 106.6563892, 10.9311634 106.6514969, 10.9361355 106.6496086, 10.941866 106.651411100000018, 10.9530737 106.6522694, 10.9641125 106.6486645, 10.9697581 106.6491795, 10.9758249 106.6500378, 10.9813018 106.6480637, 10.980712 106.6434288, 10.9770889 106.6353607, 10.9797852 106.6269493, 10.9850935 106.6217995, 10.9886323 106.616478, 10.9925081 106.6163063, 10.9978162 106.6188812, 11.0046407 106.621713600000021, 11.0108753 106.6185379, 11.0113808 106.6106415, 11.0145823 106.5989685, 11.01989 106.5960503, 11.0288201 106.5949345, 11.0393506 106.60326, 11.0427203 106.6019726, 11.0456687 106.599226, 11.0458372 106.5960503, 11.0439839 106.5934753, 11.0416252 106.592273700000021, 11.0369918 106.5913296, 11.0362336 106.5871239, 11.0379185 106.5829182, 11.0409512 106.5813732, 11.0463427 106.5808582, 11.0494595 106.5772533, 11.0536715 106.5745068, 11.0545139 106.571760200000014, 11.0511443 106.5692711, 11.0455003 106.5680695, 11.0450791 106.5630913, 11.0464269 106.55056, 11.0498807 106.5482426, 11.0535873 106.5441227, 11.0559459 106.5371704, 11.057639978163111 106.534837857345167, 11.0590627 106.5328789, 11.0657173 106.5297031, 11.0689182 106.5254974, 11.0731299 106.5239525, 11.0769204 106.5244675, 11.0825638 106.527986500000011, 11.0876176 106.533308, 11.0902287 106.533823, 11.0923343 106.5319347, 11.0898917 106.5251541, 11.0903971 106.5222359, 11.0973879 106.5172577, 11.1012623 106.5163136, 11.1037048 106.5239525, 11.1058946 106.5266132, 11.1153275 106.5279007, 11.1214755 106.5263557, 11.122065 106.5209484, 11.1267813 106.5145111, 11.1350344 106.5115929, 11.1422768 106.5073872, 11.1400031 106.501379, 11.1445506 106.489706, 11.142361 106.4823246, 11.14354 106.472196600000018, 11.1482559 106.4673901, 11.1544874 106.4712524, 11.1577716 106.4661026, 11.159961 106.4632702, 11.1586137 106.4614677, 11.158361 106.459322, 11.1602136 106.4568329, 11.1593715 106.4536572, 11.1565084 106.451683, 11.1524664 106.4514256, 11.1513717 106.4530563, 11.1532243 106.4559746, 11.152719 106.4581203, 11.1477506 106.4585495, 11.1410978 106.4558029, 11.1364661 106.4514256, 11.1355397 106.446619, 11.1080002 106.4389801, 11.0842484 106.4389801, 11.0815531 106.4295387, 11.0259558 106.4278221, 11.0156775 106.4353752, 11.0059045 106.4273071, 11.0039667 106.4239597, 10.9966366 106.4204407, 10.9909915 106.4100552, 10.9913285 106.392889, 10.9938562 106.372633, 10.9922553 106.3700581, 10.9818916 106.3637066, 10.9809648 106.3649082, 10.9695896 106.3734055, 10.9737184 106.4113426, 10.9416974 106.4536572, 10.9207976 106.4959717, 10.9033519 106.533823, 10.885800670774429 106.528854385194066, 10.7887074 106.501379, 10.7522818 106.4810371';
        if(!empty($data['special']) && $data['special']!=-1){
            $sql .= "ST_Contains(GeomFromText('POLYGON((".$data['special']."))'), Point(lat,lng)) AND ";
        }

        if(!empty($data['street']) && $data['street']!=-1){
            $sql .= "ST_Contains(GeomFromText('POLYGON((".$data['street']."))'), Point(lat,lng)) AND ";
        }

        $sql .= "status = " . $data['status'];

        $query = $this->db->query($sql);
        return $query->row['total'];
    }
}